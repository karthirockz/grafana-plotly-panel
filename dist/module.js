define(["lodash","app/plugins/sdk","moment","jquery","./lib/plotly.min"],function(e,t,n,r,o){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=1)}([function(t,n){t.exports=e},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PanelCtrl=t.PlotlyPanelCtrl=void 0;var r=n(2),o=c(n(0)),i=c(n(3)),a=c(n(4)),s=n(5),l=n(6),p=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(n(7));function c(e){return e&&e.__esModule?e:{default:e}}var d=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),u=function(e){function t(n,r,i,a,s){var l=e.call(this,n,r)||this;return l.$rootScope=a,l.uiSegmentSrv=s,l.seriesByKey=new Map,l.seriesHash="?",l.deepCopyWithTemplates=function(e){if(o.default.isArray(e))return e.map(function(e){return l.deepCopyWithTemplates(e)});if(o.default.isString(e))return l.templateSrv.replace(e,l.panel.scopedVars);if(o.default.isObject(e)){var t={};return o.default.forEach(e,function(e,n){t[n]=l.deepCopyWithTemplates(e)}),t}return e},l.initalized=!1,o.default.defaultsDeep(l.panel,t.defaults),l.cfg=l.panel.pconfig,l.traces=[],l.events?(l.events.on("init-edit-mode",l.onInitEditMode.bind(l)),l.events.on("render",l.onRender.bind(l)),l.events.on("data-received",l.onDataReceived.bind(l)),l.events.on("data-error",l.onDataError.bind(l)),l.events.on("panel-initialized",l.onPanelInitalized.bind(l)),l.events.on("panel-size-changed",l.onResize.bind(l)),l.events.on("data-snapshot-load",l.onDataSnapshotLoad.bind(l)),l.events.on("refresh",l.onRefresh.bind(l)),l):l}return d(t,e),t.$inject=["$scope","$injector","$window","$rootScope","uiSegmentSrv"],t.prototype.getCssRule=function(e){for(var t=document.styleSheets,n=0;n<t.length;n+=1)for(var r=t[n].cssRules,o=0;o<r.length;o+=1){var i=r[o];if(i.selectorText===e)return i}return null},t.prototype.onResize=function(){var e=this;setTimeout(function(){if(e.graphDiv&&e.layout){var t=window.getComputedStyle(e.graphDiv).display;if(t&&"none"!==t){var n=e.graphDiv.getBoundingClientRect();e.layout.width=n.width,e.layout.height=e.height,p.redraw(e.graphDiv)}else console.warn("resize a plot that is not drawn yet")}},75)},t.prototype.onDataError=function(e){console.log("onDataError",e)},t.prototype.onRefresh=function(){this.otherPanelInFullscreenMode()||this.graphDiv&&this.initalized&&p.redraw(this.graphDiv)},t.prototype.onInitEditMode=function(){this.editor=new l.EditorHelper(this),this.addEditorTab("Display","public/plugins/natel-plotly-panel/partials/tab_display.html",2),this.addEditorTab("Traces","public/plugins/natel-plotly-panel/partials/tab_traces.html",3),this.onConfigChanged(),this.onResize()},t.prototype.processConfigMigration=function(){console.log("Migrating Plotly Configuration to version: "+t.configVersion);var e=this.panel.pconfig;if(delete e.layout.plot_bgcolor,delete e.layout.paper_bgcolor,delete e.layout.autosize,delete e.layout.height,delete e.layout.width,delete e.layout.margin,delete e.layout.scene,this.is3d()||delete e.layout.zaxis,e.settings.mode){var n=e.settings.mode,r={markers:n.indexOf("markers")>=0,lines:n.indexOf("lines")>=0};o.default.forEach(e.traces,function(e){e.show=r}),delete e.settings.mode}console.log("After Migration:",e),this.cfg=e,this.panel.version=t.configVersion},t.prototype.onPanelInitalized=function(){(!this.panel.version||t.configVersion>this.panel.version)&&this.processConfigMigration(),this._updateTraceData(!0)},t.prototype.getProcessedLayout=function(){var e=this.deepCopyWithTemplates(this.cfg.layout);e.plot_bgcolor="transparent",e.paper_bgcolor=e.plot_bgcolor;var t=this.graphDiv.getBoundingClientRect();if(e.autosize=!1,e.height=this.height,e.width=t.width,e.xaxis||(e.xaxis={}),e.yaxis||(e.yaxis={}),this.is3d())e.zaxis||(e.zaxis={}),e.scene.xaxis.title=e.xaxis.title,e.scene.yaxis.title=e.yaxis.title,e.scene.zaxis.title=e.zaxis.title,e.margin={l:0,r:0,t:0,b:5,pad:0};else{delete e.zaxis,delete e.scene,e.margin={l:e.yaxis.title?50:35,r:5,t:0,b:e.xaxis.title?65:30,pad:2};var n=this.getCssRule("div.flot-text");if(n){var r=n.style.color;e.font||(e.font={}),e.font.color=r,r=a.default.color.parse(r).scale("a",.22).toString(),e.xaxis.gridcolor=r,e.yaxis.gridcolor=r}}return e},t.prototype.onRender=function(){var e=this;if(!this.otherPanelInFullscreenMode()&&this.graphDiv){if(this.initalized)p.redraw(this.graphDiv);else{var t={showLink:!1,displaylogo:!1,displayModeBar:this.cfg.settings.displayModeBar,modeBarButtonsToRemove:["sendDataToCloud"]};this.layout=this.getProcessedLayout(),p.react(this.graphDiv,this.traces,this.layout,t),this.graphDiv.on("plotly_click",function(t){if(void 0!==t&&void 0!==t.points)for(var n=0;n<t.points.length;n++){var r=t.points[n].pointNumber,o=e.traces[0].ts[r],a=t.points[n].x.toPrecision(4)+", "+t.points[n].y.toPrecision(4);e.$rootScope.appEvent("alert-success",[a,"@ "+e.dashboard.formatDate((0,i.default)(o))])}}),this.graphDiv.on("plotly_selected",function(t){if(void 0!==t&&void 0!==t.points)if(0!==t.points.length){console.log("SELECTED",t);for(var n=Number.MAX_SAFE_INTEGER,r=Number.MIN_SAFE_INTEGER,o=0;o<t.points.length;o++){var a=t.points[o].pointNumber,s=e.traces[0].ts[a];n=Math.min(n,s),r=Math.max(r,s)}n-=1e3,r+=1e3;var l={from:i.default.utc(n),to:i.default.utc(r)};console.log("SELECTED!!!",n,r,t.points.length,l),e.timeSrv.setTime(l),e.graphDiv&&(p.Plots.purge(e.graphDiv),e.graphDiv.innerHTML="",e.initalized=!1)}else console.log("Nothing Selected",t)})}this.initalized=!0}},t.prototype.onDataSnapshotLoad=function(e){this.onDataReceived(e)},t.prototype.onDataReceived=function(e){var t=this,n=[],r="/";e.forEach(function(e,r){var i=o.default.get(t.panel,"targets["+r+"].refId");if(i||(console.log("Missing Targets: ",t.panel.targets),i=String.fromCharCode("A".charCodeAt(0)+r)),e.columns)for(var a=0;a<e.columns.length;a++)n.push(new s.SeriesWrapperTable(i,e,a));else e.target?(n.push(new s.SeriesWrapperSeries(i,e,"value")),n.push(new s.SeriesWrapperSeries(i,e,"time")),n.push(new s.SeriesWrapperSeries(i,e,"index"))):console.error("Unsupported Series response",r,e)}),this.seriesByKey.clear(),n.forEach(function(e){var n=e.getRelativeKey();t.seriesByKey.set(n,e),e.getNamedKeys().forEach(function(n){t.seriesByKey.set(n,e)}),r+="$"+n}),this.series=n;var i=this.seriesHash!==r;i&&l.EditorHelper.updateMappings(this)&&this.editor&&(this.editor.selectTrace(this.editor.traceIndex),this.editor.onConfigChanged()),!i&&this.initalized||(this.onConfigChanged(),this.seriesHash=r),this._updateTraceData(),this.render()},t.prototype.__addCopyPath=function(e,t,n){if(t){var r=this.seriesByKey.get(t);if(r)return e.__set.push({key:r.getRelativeKey(),path:n}),!0;this.dataWarnings.push("Unable to find: "+t+" for "+e.name+" // "+n)}return!1},t.prototype._updateTracesFromConfigs=function(){var e=this;this.dataWarnings=[],(null==this.cfg.traces||this.cfg.traces.length<1)&&(this.cfg.traces=[o.default.cloneDeep(t.defaultTrace)]);var n=this.is3d();this.traces=this.cfg.traces.map(function(r,i){var a=e.deepCopyWithTemplates(r)||{};o.default.defaults(a,t.defaults);var s=a.mapping,p={name:a.name||l.EditorHelper.createTraceName(i),type:e.cfg.settings.type,mode:"markers+lines",__set:[]},c="";return a.show.markers&&(c+="+markers",p.marker=a.settings.marker,delete p.marker.sizemin,delete p.marker.sizemode,delete p.marker.sizeref,"ramp"===a.settings.color_option?e.__addCopyPath(p,s.color,"marker.color"):(delete p.marker.colorscale,delete p.marker.showscale)),a.show.lines&&(c+="+lines",p.line=a.settings.line),e.__addCopyPath(p,s.text,"text"),e.__addCopyPath(p,s.x,"x"),e.__addCopyPath(p,s.y,"y"),n&&e.__addCopyPath(p,s.z,"z"),c&&(p.mode=c.substring(1)),p}),console.log("Set-Traces",this.traces),this.refresh()},t.prototype._updateTraceData=function(e){var t=this;void 0===e&&(e=!1),this.series?(!e&&this.traces&&this.traces.length==this.cfg.traces.length||this._updateTracesFromConfigs(),this.traces.forEach(function(e){e.__set&&e.__set.forEach(function(n){var r=t.seriesByKey.get(n.key);r?o.default.set(e,n.path,r.toArray()):console.warn("Can not set",n)})})):console.log("NO Series data yet!")},t.prototype.onConfigChanged=function(){if(this._updateTraceData(!0),this.initalized&&this.graphDiv){var e={showLink:!1,displaylogo:!1,displayModeBar:this.cfg.settings.displayModeBar,modeBarButtonsToRemove:["sendDataToCloud"]};this.layout=this.getProcessedLayout(),console.log("Update-LAYOUT",this.layout,this.traces),p.react(this.graphDiv,this.traces,this.layout,e)}this.refresh()},t.prototype.is3d=function(){return"scatter3d"===this.cfg.settings.type},t.prototype.link=function(e,t,n,r){var o=this;this.graphDiv=t.find(".plotly-spot")[0],this.initalized=!1,t.on("mousemove",function(e){o.mouse=e})},t.templateUrl="partials/module.html",t.configVersion=1,t.defaultTrace={mapping:{x:null,y:null,z:null,text:null,color:null,size:null},show:{line:!0,markers:!0},settings:{line:{color:"#005f81",width:6,dash:"solid",shape:"linear"},marker:{size:15,symbol:"circle",color:"#33B5E5",colorscale:"YIOrRd",sizemode:"diameter",sizemin:3,sizeref:.2,line:{color:"#DDD",width:0},showscale:!0},color_option:"ramp"}},t.defaults={pconfig:{traces:[t.defaultTrace],settings:{type:"scatter",displayModeBar:!1},layout:{showlegend:!1,legend:{orientation:"h"},dragmode:"lasso",hovermode:"closest",font:{family:'"Open Sans", Helvetica, Arial, sans-serif'},xaxis:{showgrid:!0,zeroline:!1,type:"linear",rangemode:"normal"},yaxis:{showgrid:!0,zeroline:!1,type:"linear",rangemode:"normal"},zaxis:{showgrid:!0,zeroline:!1,type:"linear",rangemode:"normal"}}}},t}(r.MetricsPanelCtrl);t.PlotlyPanelCtrl=u,t.PanelCtrl=u},function(e,n){e.exports=t},function(e,t){e.exports=n},function(e,t){e.exports=r},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SeriesWrapperTable=t.SeriesWrapperSeries=t.SeriesWrapper=void 0;var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=function(e){return e&&e.__esModule?e:{default:e}}(n(0)),i=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),a=function(){function e(e){this.refId=e}return e.$inject=["refId"],e.prototype.setFirst=function(e){this.first=e,o.default.isNumber(e)?this.type="number":o.default.isString(e)?this.type="string":(void 0===e?"undefined":r(e))===r(!0)&&(this.type="boolean")},e}();t.SeriesWrapper=a;var s=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.series=n,i.value=r,i.count=n.datapoints.length,i.name=n.target,"index"===r?(i.first=0,i.type="number",i.name+="@index",i):"value"===r?(o.default.forEach(n.datapoints,function(e){return null===e[0]||(i.setFirst(e[0]),!1)}),i):"time"===r?(i.type="epoch",i.first=n.datapoints[0][1],i.name+="@time",i):i}return i(t,e),t.$inject=["refId","series","val"],t.prototype.toArray=function(){if("index"==this.value){for(var e=new Array(this.count),t=0;t<this.count;t++)e[t]=t;return e}var n="time"===this.value?1:0;return o.default.map(this.series.datapoints,function(e){return e[n]})},t.prototype.getRelativeKey=function(){return this.refId+"@"+this.value},t.prototype.getNamedKeys=function(){return[this.name,this.refId+"/"+this.name]},t}(a);t.SeriesWrapperSeries=s;var l=function(e){function t(t,n,r){var o=e.call(this,t)||this;o.table=n,o.index=r,o.count=n.rows.length;var i=n.columns[r];if(!i)throw"Unkonwn Column: "+r;if(o.name=i.text,"time"===i.type)o.type="epoch",o.first=n.rows[0][r];else for(var a=0;a<o.count;a++){var s=n.rows[a][r];if(null!==s)return o.setFirst(s),o}return o}return i(t,e),t.$inject=["refId","table","index"],t.prototype.toArray=function(){var e=this;return o.default.map(this.table.rows,function(t){return t[e.index]})},t.prototype.getRelativeKey=function(){return this.refId+"/"+this.name},t.prototype.getNamedKeys=function(){return[this.name,this.refId+"["+this.index+"]"]},t}(a);t.SeriesWrapperTable=l},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EditorHelper=void 0;var r=function(e){return e&&e.__esModule?e:{default:e}}(n(0)),o=n(1),i=function(){function e(t){this.ctrl=t,this.axis=new Array,this.traceIndex=0,this.mapping={},e.updateMappings(t),this.selectTrace(0)}return e.$inject=["ctrl"],e.updateMappings=function(e){if(null==e.series||e.series.length<1)return!1;var t={first:e.series[0].getRelativeKey(),time:e.series[1].getRelativeKey()},n=!1;return e.cfg.traces.forEach(function(i){r.default.defaults(i,o.PlotlyPanelCtrl.defaultTrace);var a=i.mapping;a.color||(a.color=t.first,n=!0),a.x||(a.x=t.time,n=!0),a.y||(a.y=t.first,n=!0),e.is3d()&&!a.z&&(a.z=t.first,n=!0)}),n},e.prototype.onConfigChanged=function(){this.onUpdateAxis();for(var e=0;e<this.axis.length;e++)"between"===this.axis[e].layout.rangemode?null==this.axis[e].layout.range&&(this.axis[e].layout.range=[0,null]):this.axis[e].layout.range=null;this.ctrl.onConfigChanged()},e.prototype.onUpdateAxis=function(){if(this.trace.mapping){var e=this.ctrl.cfg.layout;e.xaxis||(e.xaxis={}),e.yaxis||(e.yaxis={}),this.axis=[],this.axis.push({label:"X Axis",layout:e.xaxis,property:"x",segment:this.mapping.x}),this.axis.push({label:"Y Axis",layout:e.yaxis,property:"y",segment:this.mapping.y}),this.ctrl.is3d()&&(e.zaxis||(e.zaxis={}),this.axis.push({label:"Z Axis",layout:e.zaxis,property:"z",segment:this.mapping.z}))}else console.error("Missing mappings for trace",this.trace)},e.prototype.selectTrace=function(t){var n=this;this.traces=this.ctrl.cfg.traces,(!this.traces||this.traces.length<1)&&(this.traces=this.ctrl.cfg.traces=[r.default.deepClone(o.PlotlyPanelCtrl.defaultTrace)]),t>=this.ctrl.cfg.traces.length&&(t=this.ctrl.cfg.traces.length-1),this.trace=this.ctrl.cfg.traces[t],this.traceIndex=t,r.default.defaults(this.trace,o.PlotlyPanelCtrl.defaultTrace),this.trace.name||(this.trace.name=e.createTraceName(t)),this.symbol=this.ctrl.uiSegmentSrv.newSegment({value:this.trace.settings.marker.symbol}),this.mapping={},r.default.forEach(this.trace.mapping,function(e,t){if(e){var r=n.ctrl.seriesByKey.get(e),o={value:e,series:r,fake:null==r};n.mapping[t]=n.ctrl.uiSegmentSrv.newSegment(o)}else n.mapping[t]=n.ctrl.uiSegmentSrv.newSegment({value:"Select Metric",fake:!0})}),console.log("Editor Info",this),this.onConfigChanged(),this.ctrl.refresh()},e.prototype.createTrace=function(){var t;(t=this.ctrl.cfg.traces.length>0?r.default.cloneDeep(this.ctrl.cfg.traces[this.ctrl.cfg.traces.length-1]):r.default.deepClone(o.PlotlyPanelCtrl.defaultTrace)).name=e.createTraceName(this.ctrl.traces.length),this.ctrl.cfg.traces.push(t),this.selectTrace(this.ctrl.cfg.traces.length-1)},e.prototype.removeCurrentTrace=function(){if(this.traces.length<=1)console.error("Wont remove a single trace",this);else{for(var e=0;e<this.traces.length;e++)if(this.trace===this.traces[e])return this.traces.splice(e,1),e>=this.traces.length&&(e=this.traces.length-1),this.ctrl.onConfigChanged(),this.ctrl._updateTraceData(!0),this.selectTrace(e),void this.ctrl.refresh();console.error("Could not find",this)}},e.createTraceName=function(e){return"Trace "+(e+1)},e.prototype.getSeriesSegs=function(e){var t=this;return void 0===e&&(e=!1),new Promise(function(e,n){var r=[];t.ctrl.series.forEach(function(e){r.push(t.ctrl.uiSegmentSrv.newSegment({value:e.getRelativeKey(),series:e}))}),console.log("GET Series",r,t.ctrl.series),e(r)})},e.prototype.onAxisSeriesChanged=function(e){console.log("CHANGE",e),this.trace.mapping[e.property]=e.segment.value,this.onConfigChanged()},e.prototype.onTextMetricChanged=function(){var e=this.mapping.text;this.trace.mapping.text=e.value,this.onConfigChanged()},e.prototype.onColorChanged=function(){var e=this.mapping.color;this.trace.mapping.color=e.value,this.onConfigChanged()},e.prototype.onSymbolChanged=function(){this.trace.settings.marker.symbol=this.symbol.value,this.onConfigChanged()},e.prototype.getSymbolSegs=function(){var e=this;return new Promise(function(t,n){var o=[];r.default.forEach(["circle","circle-open","circle-dot","circle-open-dot","square","square-open","square-dot","square-open-dot","diamond","diamond-open","diamond-dot","diamond-open-dot","cross","cross-open","cross-dot","cross-open-dot","x","x-open","x-dot","x-open-dot","triangle-up","triangle-up-open","triangle-up-dot","triangle-up-open-dot","triangle-down","triangle-down-open","triangle-down-dot","triangle-down-open-dot","triangle-left","triangle-left-open","triangle-left-dot","triangle-left-open-dot","triangle-right","triangle-right-open","triangle-right-dot","triangle-right-open-dot","triangle-ne","triangle-ne-open","triangle-ne-dot","triangle-ne-open-dot","triangle-se","triangle-se-open","triangle-se-dot","triangle-se-open-dot","triangle-sw","triangle-sw-open","triangle-sw-dot","triangle-sw-open-dot","triangle-nw","triangle-nw-open","triangle-nw-dot","triangle-nw-open-dot","pentagon","pentagon-open","pentagon-dot","pentagon-open-dot","hexagon","hexagon-open","hexagon-dot","hexagon-open-dot","hexagon2","hexagon2-open","hexagon2-dot","hexagon2-open-dot","octagon","octagon-open","octagon-dot","octagon-open-dot","star","star-open","star-dot","star-open-dot","hexagram","hexagram-open","hexagram-dot","hexagram-open-dot","star-triangle-up","star-triangle-up-open","star-triangle-up-dot","star-triangle-up-open-dot","star-triangle-down","star-triangle-down-open","star-triangle-down-dot","star-triangle-down-open-dot","star-square","star-square-open","star-square-dot","star-square-open-dot","star-diamond","star-diamond-open","star-diamond-dot","star-diamond-open-dot","diamond-tall","diamond-tall-open","diamond-tall-dot","diamond-tall-open-dot","diamond-wide","diamond-wide-open","diamond-wide-dot","diamond-wide-open-dot","hourglass","hourglass-open","bowtie","bowtie-open","circle-cross","circle-cross-open","circle-x","circle-x-open","square-cross","square-cross-open","square-x","square-x-open","diamond-cross","diamond-cross-open","diamond-x","diamond-x-open","cross-thin","cross-thin-open","x-thin","x-thin-open","asterisk","asterisk-open","hash","hash-open","hash-dot","hash-open-dot","y-up","y-up-open","y-down","y-down-open","y-left","y-left-open","y-right","y-right-open","line-ew","line-ew-open","line-ns","line-ns-open","line-ne","line-ne-open","line-nw","line-nw-open"],function(t){o.push(e.ctrl.uiSegmentSrv.newSegment(t))}),t(o)})},e}();t.EditorHelper=i},function(e,t){e.exports=o}])});
//# sourceMappingURL=module.js.map